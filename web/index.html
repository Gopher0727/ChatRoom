<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go ChatRoom Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>
    <style>
        :root {
            --primary-color: #5865F2;
            --bg-color: #36393f;
            --sidebar-bg: #2f3136;
            --chat-bg: #36393f;
            --text-color: #dcddde;
            --input-bg: #40444b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Login/Register Styles */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-box {
            background-color: var(--sidebar-bg);
            padding: 2rem;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-box h2 {
            text-align: center;
            color: #fff;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: var(--input-bg);
            border: 1px solid #202225;
            border-radius: 4px;
            color: #fff;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            background-color: #4752c4;
        }

        .switch-auth {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* Main App Styles */
        #app-container {
            display: none;
            /* Hidden by default */
            width: 100%;
            height: 100%;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid #202225;
        }

        .user-info {
            padding: 10px;
            border-bottom: 1px solid #202225;
            margin-bottom: 10px;
        }

        .guild-controls {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #202225;
        }

        .guild-list {
            flex: 1;
            overflow-y: auto;
        }

        .guild-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .guild-item:hover {
            background-color: #40444b;
        }

        .guild-item.active {
            background-color: #40444b;
            color: #fff;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #26272d;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 15px;
        }

        .message-container.self {
            align-items: flex-end;
        }

        .message-container.other {
            align-items: flex-start;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-container.self .message-header {
            flex-direction: row-reverse;
        }

        .username {
            font-weight: bold;
            color: #fff;
        }

        .timestamp {
            font-size: 0.75em;
            color: #72767d;
        }

        .content {
            color: #dcddde;
            word-wrap: break-word;
            background-color: #40444b;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .message-container.self .content {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0;
        }

        .message-container.other .content {
            border-bottom-left-radius: 0;
        }

        .input-area {
            padding: 20px;
            background-color: var(--chat-bg);
        }

        .input-area form {
            display: flex;
            gap: 10px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .invite-code-display {
            background: #202225;
            padding: 5px;
            border-radius: 4px;
            font-family: monospace;
            margin-top: 5px;
            user-select: all;
        }
    </style>
</head>

<body>

    <!-- Auth Container -->
    <div id="auth-container">
        <div class="auth-box" id="login-box">
            <h2>登录</h2>
            <input type="text" id="login-username" placeholder="用户名">
            <input type="password" id="login-password" placeholder="密码">
            <button onclick="login()">登录</button>
            <div class="switch-auth" onclick="showRegister()">没有账号？去注册</div>
        </div>

        <div class="auth-box hidden" id="register-box">
            <h2>注册</h2>
            <input type="text" id="reg-username" placeholder="用户名">
            <input type="email" id="reg-email" placeholder="邮箱">
            <input type="password" id="reg-password" placeholder="密码">
            <button onclick="register()">注册</button>
            <div class="switch-auth" onclick="showLogin()">已有账号？去登录</div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-info">
                <div id="current-username" style="font-weight: bold; color: #fff;">User</div>
                <div style="font-size: 0.8em; color: #b9bbbe;">ID: <span id="current-userid"></span></div>
                <button onclick="logout()"
                    style="padding: 5px; margin-top: 5px; font-size: 0.8em; background-color: #ed4245;">退出登录</button>
            </div>

            <div class="guild-controls">
                <input type="text" id="new-guild-topic" placeholder="新群组名称" style="font-size: 0.9em;">
                <button onclick="createGuild()"
                    style="padding: 5px; font-size: 0.9em; background-color: #3ba55c;">创建群组</button>

                <div style="margin-top: 10px; border-top: 1px solid #3f4147; padding-top: 10px;">
                    <input type="text" id="join-invite-code" placeholder="输入邀请码" style="font-size: 0.9em;">
                    <button onclick="joinGuild()" style="padding: 5px; font-size: 0.9em;">加入群组</button>
                </div>
            </div>

            <div
                style="padding: 0 10px; font-size: 0.8em; text-transform: uppercase; color: #8e9297; font-weight: bold;">
                我的群组 (手动切换)
            </div>
            <div class="guild-list" id="guild-list">
                <!-- Guild items will be added here -->
                <div style="padding: 10px; color: #72767d; font-size: 0.9em;">
                    暂无群组列表接口，<br>请创建或加入后<br>在此临时显示。
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <span id="chat-title">请选择或创建一个群组</span>
                <button id="invite-btn" onclick="createInvite()" class="hidden"
                    style="width: auto; padding: 5px 10px; font-size: 0.9em; background-color: #5865F2;">生成邀请码</button>
            </div>
            <div id="invite-result" style="padding: 0 15px; display: none;"></div>

            <div class="messages" id="messages-container">
                <!-- Messages go here -->
            </div>

            <div class="input-area">
                <form onsubmit="sendMessage(event)">
                    <input type="text" id="message-input" placeholder="发送消息..." disabled autocomplete="off">
                    <button type="submit" id="send-btn" style="width: 80px;" disabled>发送</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Use relative path for API to go through Nginx proxy
        const API_BASE = '/api/v1';
        // Use current host for WebSocket to go through Nginx proxy
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_BASE = `${protocol}//${window.location.host}/ws`;

        let state = {
            token: sessionStorage.getItem('token') || null,
            user: JSON.parse(sessionStorage.getItem('user') || 'null'),
            currentGuildId: null,
            guilds: [],
            socket: null
        };

        // Protobuf Root Definition
        let WSMessage;
        const protoRoot = protobuf.Root.fromJSON({
            nested: {
                chat: {
                    nested: {
                        MessageType: { values: { TEXT: 0, SYSTEM: 1 } },
                        WSMessage: {
                            fields: {
                                messageId: { type: "string", id: 1 },
                                userId: { type: "string", id: 2 },
                                guildId: { type: "string", id: 3 },
                                content: { type: "string", id: 4 },
                                seqId: { type: "int64", id: 5 },
                                timestamp: { type: "int64", id: 6 },
                                type: { type: "MessageType", id: 7 },
                                username: { type: "string", id: 8 }
                            }
                        }
                    }
                }
            }
        });
        WSMessage = protoRoot.lookupType("chat.WSMessage");

        // --- Auth Functions ---

        function showRegister() {
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('register-box').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('register-box').classList.add('hidden');
            document.getElementById('login-box').classList.remove('hidden');
        }

        async function register() {
            const username = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('注册成功，请登录');
                    showLogin();
                } else {
                    alert('注册失败: ' + data.error);
                }
            } catch (e) {
                alert('请求错误: ' + e);
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    state.token = data.token;
                    state.user = data.user;
                    sessionStorage.setItem('token', state.token);
                    sessionStorage.setItem('user', JSON.stringify(state.user));
                    initApp();
                } else {
                    alert('登录失败: ' + data.error);
                }
            } catch (e) {
                alert('请求错误: ' + e);
            }
        }

        function logout() {
            state.token = null;
            state.user = null;
            state.currentGuildId = null;
            if (state.socket) {
                state.socket.close();
            }
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            location.reload();
        }

        // --- App Logic ---

        function initApp() {
            if (!state.token) return;

            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            document.getElementById('current-username').textContent = state.user.username;
            document.getElementById('current-userid').textContent = state.user.id;

            fetchGuildList(); // 从服务器获取最新的群组列表
            // Don't connect WS here, wait for guild selection
        }

        async function fetchGuildList() {
            try {
                // Updated API endpoint to match backend router
                const res = await fetch(`${API_BASE}/guilds`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    state.guilds = data || [];
                    // 更新 sessionStorage，虽然现在主要依赖内存中的 state.guilds
                    sessionStorage.setItem('guilds', JSON.stringify(state.guilds));
                    renderGuildList();
                } else {
                    console.error('Failed to fetch guilds:', data.error);
                }
            } catch (e) {
                console.error('Error fetching guilds:', e);
            }
        }

        function connectWS(guildId) {
            if (state.socket) {
                state.socket.close();
                state.socket = null;
            }

            const url = `${WS_BASE}?token=${state.token}&guild_id=${guildId}`;
            state.socket = new WebSocket(url);
            state.socket.binaryType = "arraybuffer"; // Important for Protobuf

            state.socket.onopen = () => {
                console.log(`WebSocket Connected (Guild: ${guildId})`);
            };

            state.socket.onmessage = (event) => {
                try {
                    // Decode Protobuf message
                    const buffer = new Uint8Array(event.data);
                    const message = WSMessage.decode(buffer);
                    const object = WSMessage.toObject(message, {
                        longs: String,
                        enums: String,
                        bytes: String,
                    });

                    // Normalize object to match internal usage
                    const normalizedMsg = {
                        id: object.messageId,
                        user_id: object.userId,
                        guild_id: object.guildId,
                        content: object.content,
                        created_at: new Date(parseInt(object.timestamp)).toISOString(),
                        sender_name: object.username || object.userId // Use username if available
                    };

                    if (normalizedMsg.guild_id === state.currentGuildId) {
                        appendMessage(normalizedMsg);
                    } else {
                        console.log(`Received message for guild ${normalizedMsg.guild_id}`);
                    }
                } catch (e) {
                    console.error("Failed to decode message:", e);
                }
            };

            state.socket.onclose = () => {
                console.log('WebSocket Disconnected');
                state.socket = null;
                // Only reconnect if we still have a current guild selected
                if (state.currentGuildId === guildId) {
                    setTimeout(() => connectWS(guildId), 3000);
                }
            };
        }

        // --- Guild Functions ---

        async function createGuild() {
            const name = document.getElementById('new-guild-topic').value;
            if (!name) return alert('请输入群组名称');

            try {
                const res = await fetch(`${API_BASE}/guilds`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({ name })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`群组 "${data.name}" 创建成功 (ID: ${data.id})`);
                    // 刷新列表
                    await fetchGuildList();
                    // 重连 WebSocket 以更新订阅关系
                    if (state.socket) {
                        state.socket.close();
                        state.socket = null;
                        setTimeout(connectWS, 500);
                    }
                    document.getElementById('new-guild-topic').value = '';
                } else {
                    alert('创建失败: ' + data.error);
                }
            } catch (e) {
                alert('请求错误: ' + e);
            }
        }

        async function joinGuild() {
            const code = document.getElementById('join-invite-code').value;
            if (!code) return alert('请输入邀请码');

            try {
                const res = await fetch(`${API_BASE}/guilds/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({ invite_code: code })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('加入成功');
                    // 刷新列表
                    await fetchGuildList();
                    // 重连 WebSocket 以更新订阅关系
                    if (state.socket) {
                        state.socket.close();
                        state.socket = null;
                        setTimeout(connectWS, 500);
                    }
                    document.getElementById('join-invite-code').value = '';
                } else {
                    alert('加入失败: ' + data.error);
                }
            } catch (e) {
                alert('请求错误: ' + e);
            }
        }

        async function createInvite() {
            const guild = state.guilds.find(g => g.id === state.currentGuildId);
            if (guild && guild.invite_code) {
                const resultDiv = document.getElementById('invite-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<div class="invite-code-display">邀请码: ${guild.invite_code}</div>`;
            } else {
                alert("无法获取当前群组的邀请码");
            }
        }

        // --- Chat Functions ---

        function renderGuildList() {
            const list = document.getElementById('guild-list');
            list.innerHTML = '';
            state.guilds.forEach(g => {
                const item = document.createElement('div');
                item.className = `guild-item ${state.currentGuildId === g.id ? 'active' : ''}`;
                item.textContent = `${g.name} (ID: ${g.id})`;
                item.onclick = () => selectGuild(g.id, g.name);
                list.appendChild(item);
            });
        }

        async function selectGuild(id, name) {
            state.currentGuildId = id;
            document.getElementById('chat-title').textContent = `# ${name}`;
            document.getElementById('invite-btn').classList.remove('hidden'); // Show invite button
            document.getElementById('invite-result').style.display = 'none';
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;

            renderGuildList(); // update active state

            // Connect WebSocket for this guild
            connectWS(id);

            // Load history
            await loadMessages(id);
        }

        async function loadMessages(guildId) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '<div style="text-align:center; color:#72767d;">加载中...</div>';

            try {
                // Updated API endpoint to match backend router
                const res = await fetch(`${API_BASE}/messages?guild_id=${guildId}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await res.json();

                container.innerHTML = '';
                if (res.ok && data.messages) {
                    // API 返回的是倒序 (最新的在前)，我们需要正序显示
                    data.messages.reverse().forEach(msg => {
                        // Ensure sender_name exists (API returns user_id)
                        msg.sender_name = msg.user_id;
                        appendMessage(msg);
                    });
                    scrollToBottom();
                } else {
                    container.innerHTML = '<div style="text-align:center; color:#ed4245;">加载失败</div>';
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="text-align:center; color:#ed4245;">加载错误</div>';
            }
        }

        function appendMessage(msg) {
            const container = document.getElementById('messages-container');

            // Create wrapper for alignment
            const wrapper = document.createElement('div');
            const isSelf = msg.user_id === state.user.id;
            wrapper.className = `message-container ${isSelf ? 'self' : 'other'}`;

            const div = document.createElement('div');
            div.className = 'message';

            const date = new Date(msg.created_at).toLocaleString();
            const sender = msg.sender_name || msg.user_id || 'Unknown';

            div.innerHTML = `
                <div class="message-header">
                    <span class="username">${sender}</span>
                    <span class="timestamp">${date}</span>
                </div>
                <div class="content">${escapeHtml(msg.content)}</div>
            `;

            wrapper.appendChild(div);
            container.appendChild(wrapper);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const content = input.value.trim();

            if (!content || !state.currentGuildId) return;

            // 使用 WebSocket 发送
            if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                const payload = {
                    guild_id: state.currentGuildId,
                    content: content,
                    type: 0 // TEXT (matches MessageType enum)
                };
                // Backend accepts JSON and unmarshals to Proto struct
                state.socket.send(JSON.stringify(payload));
                input.value = '';
            } else {
                alert('WebSocket 未连接');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Check login on load
        if (state.token) {
            initApp();
        }
    </script>
</body>

</html>